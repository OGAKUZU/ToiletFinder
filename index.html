<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>トイレファインダー - 自転車でも安心</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f5f5f5; color: #333; }
        header { background: linear-gradient(135deg, #4CAF50, #45a049); color: white; padding: 1rem; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        header h1 { font-size: 2rem; margin-bottom: 0.5rem; }
        header p { opacity: 0.9; font-size: 1rem; }
        main { max-width: 1200px; margin: 0 auto; padding: 1rem; }
        .controls { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .btn-primary, .btn-secondary { padding: 0.75rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; font-weight: 500; transition: all 0.3s ease; }
        .btn-primary { background-color: #4CAF50; color: white; }
        .btn-primary:hover { background-color: #45a049; transform: translateY(-2px); }
        .btn-secondary { background-color: #2196F3; color: white; }
        .btn-secondary:hover { background-color: #1976D2; transform: translateY(-2px); }
        #map { width: 100%; height: 70vh; min-height: 400px; border-radius: 10px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .emergency-btn { background: #f44336 !important; color: white; font-weight: bold; animation: pulse 1s infinite; padding: 0.75rem 1.5rem; border: none; border-radius: 5px; cursor: pointer; font-size: 1rem; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        .error-message { background: #ffebee; color: #c62828; padding: 1rem; border-radius: 5px; margin: 1rem 0; }
    </style>
</head>
<body>
    <header>
        <h1>🚻 トイレファインダー</h1>
        <p>自転車での遠出も安心！みんなでトイレ情報を共有しよう</p>
    </header>
    
    <main>
        <div class="controls">
            <button class="btn-primary" onclick="addToilet()">📍 トイレを追加</button>
            <button class="btn-secondary" onclick="getCurrentLocation()">📍 現在地</button>
            <button class="btn-secondary" onclick="searchNearby()">🔍 周辺のコンビニ検索</button>
            <button class="emergency-btn" onclick="emergencyMode()">🚨 緊急！</button>
        </div>
        
        <div id="map"></div>
        <div id="error-message" class="error-message" style="display:none;"></div>
    </main>

    <script>
        let map;
        let markers = [];
        let currentLocation = null;
        
        // 初期トイレデータ
        const toilets = [
            { name: "東京駅 丸の内南口", lat: 35.6797, lng: 139.7677 },
            { name: "渋谷駅 ハチ公口", lat: 35.6590, lng: 139.7005 },
            { name: "新宿駅 南口", lat: 35.6896, lng: 139.7006 },
            { name: "雷門前", lat: 35.7105, lng: 139.7927 },
            { name: "上野公園", lat: 35.7150, lng: 139.7730 }
        ];
        
        function initMap() {
            try {
                console.log('地図初期化開始');
                
                // 地図を初期化
                map = new google.maps.Map(document.getElementById('map'), {
                    zoom: 13,
                    center: { lat: 35.6762, lng: 139.6503 }
                });
                
                // トイレマーカーを追加
                toilets.forEach(toilet => {
                    const marker = new google.maps.Marker({
                        position: { lat: toilet.lat, lng: toilet.lng },
                        map: map,
                        title: toilet.name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 15,
                            fillColor: '#4CAF50',
                            fillOpacity: 0.8,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div><h3>' + toilet.name + '</h3><p>公衆トイレ</p></div>'
                    });
                    
                    marker.addListener('click', function() {
                        infoWindow.open(map, marker);
                    });
                    
                    markers.push(marker);
                });
                
                // 現在地を取得
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(function(position) {
                        currentLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        new google.maps.Marker({
                            position: currentLocation,
                            map: map,
                            title: '現在地',
                            icon: {
                                path: google.maps.SymbolPath.CIRCLE,
                                scale: 10,
                                fillColor: '#2196F3',
                                fillOpacity: 0.8,
                                strokeColor: 'white',
                                strokeWeight: 2
                            }
                        });
                        
                        map.setCenter(currentLocation);
                    });
                }
                
                console.log('地図初期化完了');
            } catch (error) {
                console.error('地図初期化エラー:', error);
                showError('地図の初期化に失敗しました: ' + error.message);
            }
        }
        
        function addToilet() {
            if (!map) {
                alert('地図が初期化されていません');
                return;
            }
            
            alert('地図上をクリックしてトイレの位置を指定してください');
            
            google.maps.event.addListenerOnce(map, 'click', function(event) {
                const name = prompt('トイレの名前を入力してください:');
                if (name) {
                    const marker = new google.maps.Marker({
                        position: event.latLng,
                        map: map,
                        title: name,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 15,
                            fillColor: '#FF9800',
                            fillOpacity: 0.8,
                            strokeColor: 'white',
                            strokeWeight: 2
                        }
                    });
                    
                    const infoWindow = new google.maps.InfoWindow({
                        content: '<div><h3>' + name + '</h3><p>ユーザー追加</p></div>'
                    });
                    
                    marker.addListener('click', function() {
                        infoWindow.open(map, marker);
                    });
                    
                    markers.push(marker);
                    alert('トイレを追加しました！');
                }
            });
        }
        
        function getCurrentLocation() {
            if (currentLocation) {
                map.setCenter(currentLocation);
                map.setZoom(15);
            } else {
                alert('現在地を取得中です...');
            }
        }
        
        function searchNearby() {
            alert('周辺のコンビニを検索中... (この機能は開発中です)');
        }
        
        function emergencyMode() {
            if (!currentLocation) {
                alert('現在地が取得できません！');
                return;
            }
            
            let nearestToilet = null;
            let minDistance = Infinity;
            
            toilets.forEach(toilet => {
                const distance = getDistance(
                    currentLocation.lat, currentLocation.lng,
                    toilet.lat, toilet.lng
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearestToilet = toilet;
                }
            });
            
            if (nearestToilet) {
                map.setCenter({ lat: nearestToilet.lat, lng: nearestToilet.lng });
                map.setZoom(16);
                alert('最寄りトイレ: ' + nearestToilet.name + '\n距離: 約' + Math.round(minDistance * 1000) + 'm');
            }
        }
        
        function getDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }
        
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
            }
        }
        
        // グローバルに公開
        window.initMap = initMap;
    </script>
    
    <!-- Google Maps API -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBRcfuL5q0oWg1t4hW6pwj8iA_XFUSSJ5E&callback=initMap"></script>
</body>
</html>
